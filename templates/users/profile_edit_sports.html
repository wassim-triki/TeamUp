{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Sports Interests - TeamUp{% endblock %}

{% block extra_css %}
<style>
    /* Bumble-style sport capsules */
    .sport-capsules-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .sport-capsule {
        position: relative;
        display: inline-block;
    }

    .sport-capsule input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    .sport-capsule-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        background: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        user-select: none;
    }

    .sport-capsule-icon {
        font-size: 20px;
        line-height: 1;
    }

    .sport-capsule-name {
        line-height: 1;
    }

    /* Hover effect */
    .sport-capsule-label:hover {
        border-color: #50b5ff;
        background: #f8fcff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(80, 181, 255, 0.15);
    }

    /* Selected state */
    .sport-capsule input[type="checkbox"]:checked + .sport-capsule-label {
        background: linear-gradient(135deg, #50b5ff 0%, #2e8bc0 100%);
        border-color: #50b5ff;
        color: #fff;
        box-shadow: 0 4px 12px rgba(80, 181, 255, 0.3);
    }

    /* Selected hover */
    .sport-capsule input[type="checkbox"]:checked + .sport-capsule-label:hover {
        background: linear-gradient(135deg, #2e8bc0 0%, #1a5f8a 100%);
        transform: translateY(-2px);
    }

    /* Animation */
    .sport-capsule-label {
        animation: fadeInUp 0.4s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Stagger animation for capsules */
    .sport-capsule:nth-child(1) .sport-capsule-label { animation-delay: 0.05s; }
    .sport-capsule:nth-child(2) .sport-capsule-label { animation-delay: 0.1s; }
    .sport-capsule:nth-child(3) .sport-capsule-label { animation-delay: 0.15s; }
    .sport-capsule:nth-child(4) .sport-capsule-label { animation-delay: 0.2s; }
    .sport-capsule:nth-child(5) .sport-capsule-label { animation-delay: 0.25s; }
    .sport-capsule:nth-child(6) .sport-capsule-label { animation-delay: 0.3s; }
    .sport-capsule:nth-child(7) .sport-capsule-label { animation-delay: 0.35s; }
    .sport-capsule:nth-child(8) .sport-capsule-label { animation-delay: 0.4s; }
    .sport-capsule:nth-child(9) .sport-capsule-label { animation-delay: 0.45s; }
    .sport-capsule:nth-child(10) .sport-capsule-label { animation-delay: 0.5s; }

    /* Search results dropdown */
    .sport-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        margin-top: 4px;
    }

    .sport-search-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #f5f5f5;
    }

    .sport-search-item:last-child {
        border-bottom: none;
    }

    .sport-search-item:hover {
        background: #f8fcff;
    }

    .sport-search-item-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sport-search-icon {
        font-size: 20px;
    }

    .sport-search-name {
        font-weight: 500;
        color: #333;
    }

    .sport-search-category {
        font-size: 12px;
        color: #999;
        margin-left: auto;
    }

    /* Category filter buttons */
    .category-filter {
        text-transform: capitalize;
    }

    .category-filter.active {
        background-color: #50b5ff;
        border-color: #50b5ff;
        color: #fff;
    }

    /* Input group styling */
    .input-group-text {
        border-right: none;
    }

    #sportSearch {
        border-left: none;
    }

    #sportSearch:focus {
        box-shadow: none;
        border-color: #ced4da;
    }

    /* Load More Button */
    #loadMoreBtn {
        padding: 8px 24px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    #loadMoreBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(80, 181, 255, 0.3);
    }

    #remainingCount {
        font-size: 12px;
        opacity: 0.8;
    }

    .iq-edit-list ul {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        border-bottom: 2px solid #e6e6e6;
    }

    .iq-edit-list ul li {
        flex: 1;
    }

    .iq-edit-list ul li a {
        display: block;
        padding: 20px;
        text-align: center;
        text-decoration: none;
        color: #6c757d;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .iq-edit-list ul li a:hover {
        color: #667eea;
        background: #f8f9fa;
    }

    .iq-edit-list ul li a.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-page" class="content-page">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="iq-edit-list">
                            <ul class="iq-edit-profile row nav nav-pills">
                                <li class="col-md-3 p-0">
                                    <a class="nav-link {% if active_tab == 'personal-information' %}active{% endif %}" href="{% url 'users:edit_profile' %}">
                                        Personal Information
                                    </a>
                                </li>
                                <li class="col-md-3 p-0">
                                    <a class="nav-link {% if active_tab == 'edit-sports' %}active{% endif %}" href="{% url 'users:edit_sports' %}">
                                        Sports Interests
                                    </a>
                                </li>
                                <li class="col-md-3 p-0">
                                    <a class="nav-link {% if active_tab == 'change-pwd' %}active{% endif %}" href="{% url 'users:change_password' %}">
                                        Change Password
                                    </a>
                                </li>
                                <li class="col-md-3 p-0">
                                    <a class="nav-link {% if active_tab == 'manage-contact' %}active{% endif %}" href="{% url 'users:manage_contact' %}">
                                        Change Email
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <div class="header-title">
                            <h4 class="card-title">Sports Interests</h4>
                        </div>
                    </div>
                    <div class="card-body">


                        <form method="POST" action="{% url 'users:edit_sports' %}" id="sportsForm">
                            {% csrf_token %}

                            <div class="form-group">
                                <label class="form-label mb-3">
                                    <strong>Select Your Sports Interests</strong>
                                </label>
                                <small class="form-text text-muted d-block mb-3">
                                    Choose all sports you're interested in or actively participate in
                                </small>

                                <!-- Search Bar -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="ri-search-line"></i>
                                        </span>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="sportSearch"
                                            placeholder="Search sports..."
                                            autocomplete="off"
                                        />
                                    </div>
                                    <div id="searchResults" class="sport-search-results" style="display: none;"></div>
                                </div>

                                <!-- Category Filter -->
                                <div class="mb-3">
                                    <div class="btn-group" role="group" aria-label="Sport categories">
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter active" data-category="all">
                                            All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter" data-category="team">
                                            Team
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter" data-category="racket">
                                            Racket
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter" data-category="fitness">
                                            Fitness
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter" data-category="water">
                                            Water
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary category-filter" data-category="combat">
                                            Combat
                                        </button>
                                    </div>
                                </div>

                                <!-- Selected Sports Display -->
                                <div id="selectedSportsContainer" class="sport-capsules-container mb-3">
                                    <!-- Selected sports will appear here -->
                                </div>

                                <!-- Available Sports Display -->
                                <div id="availableSportsContainer" class="sport-capsules-container">
                                    <!-- Loading indicator -->
                                    <div class="text-center w-100 py-3" id="sportsLoader">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Load More Button -->
                                <div class="text-center mt-3" id="loadMoreContainer" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMoreSports()">
                                        Load More Sports <span id="remainingCount"></span>
                                    </button>
                                </div>

                                <!-- Hidden inputs for form submission -->
                                <div id="hiddenSportsInputs"></div>

                                <div class="invalid-feedback" id="sports-error" style="display: none;">
                                    Please select at least one sport.
                                </div>
                            </div>                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="ri-save-line me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Sports Management System with Search, Filters, and Pagination
    let allSports = [];
    let selectedSports = new Set();
    let currentCategory = 'all';
    let displayedSportsCount = 0;
    const INITIAL_LOAD = 15; // Show 15 sports initially
    const LOAD_MORE_COUNT = 10; // Load 10 more each time
    let isSearching = false;
    let searchQuery = '';

    // Load sports from API
    async function loadSports() {
        try {
            const response = await fetch('/api/sports/search/?limit=100');
            const data = await response.json();
            
            if (data.status === 'success') {
                allSports = data.results;
                
                // Pre-select user's current sports FIRST
                const userSports = {{ user_sports|safe }};
                userSports.forEach(sportId => {
                    const sport = allSports.find(s => s.id === sportId);
                    if (sport) {
                        selectedSports.add(sport.id);
                    }
                });
                
                // Now render selected sports at top
                renderSelectedSports();
                
                // Then render available sports (excluding selected ones)
                displayedSportsCount = 0;
                renderAvailableSports(INITIAL_LOAD);
                updateLoadMoreButton();
                updateHiddenInputs();
            }
        } catch (error) {
            console.error('Error loading sports:', error);
            document.getElementById('sportsLoader').innerHTML = '<p class="text-danger">Error loading sports. Please refresh the page.</p>';
        }
    }

    // Get filtered sports based on category and search
    function getFilteredSports() {
        return allSports.filter(sport => {
            const matchesCategory = currentCategory === 'all' || sport.category === currentCategory;
            const notSelected = !selectedSports.has(sport.id);
            const matchesSearch = !searchQuery || 
                sport.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (sport.description && sport.description.toLowerCase().includes(searchQuery.toLowerCase()));
            
            return matchesCategory && notSelected && matchesSearch;
        });
    }

    // Render available sports with pagination
    function renderAvailableSports(count = null) {
        const container = document.getElementById('availableSportsContainer');
        const loader = document.getElementById('sportsLoader');
        
        if (loader) {
            loader.remove();
        }
        
        const filteredSports = getFilteredSports();
        
        // Determine how many to show
        let sportsToShow;
        if (count !== null) {
            sportsToShow = filteredSports.slice(0, count);
            displayedSportsCount = count;
        } else {
            sportsToShow = filteredSports.slice(0, displayedSportsCount);
        }
        
        if (sportsToShow.length === 0) {
            container.innerHTML = '<p class="text-muted text-center w-100 py-3">No sports found</p>';
            document.getElementById('loadMoreContainer').style.display = 'none';
            return;
        }
        
        container.innerHTML = sportsToShow.map(sport => `
            <div class="sport-capsule" data-sport-id="${sport.id}">
                <label class="sport-capsule-label" onclick="selectSportById(${sport.id})" style="cursor: pointer;">
                    <span class="sport-capsule-icon">${sport.emoji}</span>
                    <span class="sport-capsule-name">${sport.name}</span>
                </label>
            </div>
        `).join('');
        
        updateLoadMoreButton();
    }

    // Update Load More button visibility and text
    function updateLoadMoreButton() {
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const remainingCountSpan = document.getElementById('remainingCount');
        const filteredSports = getFilteredSports();
        const remaining = filteredSports.length - displayedSportsCount;
        
        if (remaining > 0 && !isSearching) {
            loadMoreContainer.style.display = 'block';
            remainingCountSpan.textContent = `(${remaining} more)`;
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }

    // Load more sports
    function loadMoreSports() {
        displayedSportsCount += LOAD_MORE_COUNT;
        renderAvailableSports(displayedSportsCount);
    }

    // Select a sport
    function selectSport(sport) {
        if (selectedSports.has(sport.id)) return;
        
        selectedSports.add(sport.id);
        renderSelectedSports();
        renderAvailableSports();
        updateHiddenInputs();
        hideError();
    }

    // Select sport by ID
    function selectSportById(sportId) {
        const sport = allSports.find(s => s.id === sportId);
        if (sport) {
            selectSport(sport);
        }
    }

    // Deselect a sport
    function deselectSport(sportId) {
        selectedSports.delete(sportId);
        renderSelectedSports();
        renderAvailableSports();
        updateHiddenInputs();
    }

    // Render selected sports
    function renderSelectedSports() {
        const container = document.getElementById('selectedSportsContainer');
        const selectedSportsList = Array.from(selectedSports).map(id => 
            allSports.find(s => s.id === id)
        ).filter(Boolean);
        
        if (selectedSportsList.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = selectedSportsList.map(sport => `
            <div class="sport-capsule" data-sport-id="${sport.id}">
                <label class="sport-capsule-label" style="background: linear-gradient(135deg, #50b5ff 0%, #2e8bc0 100%); color: #fff; border-color: #50b5ff; position: relative; padding-right: 35px;">
                    <span class="sport-capsule-icon">${sport.emoji}</span>
                    <span class="sport-capsule-name">${sport.name}</span>
                    <button type="button" onclick="deselectSport(${sport.id})" style="position: absolute; right: 10px; background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; padding: 0; line-height: 1;" aria-label="Remove ${sport.name}">Ã—</button>
                </label>
            </div>
        `).join('');
    }

    // Update hidden inputs for form submission
    function updateHiddenInputs() {
        const container = document.getElementById('hiddenSportsInputs');
        const selectedSportsList = Array.from(selectedSports);
        
        container.innerHTML = selectedSportsList.map(sportId => `
            <input type="hidden" name="sports" value="${sportId}">
        `).join('');
    }

    // Hide error message
    function hideError() {
        const error = document.getElementById('sports-error');
        if (error) {
            error.style.display = 'none';
        }
    }

    // Real-time search functionality (debounced)
    let searchTimeout;
    document.getElementById('sportSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchQuery = e.target.value.trim();
        
        // Hide dropdown search results when typing in main search
        document.getElementById('searchResults').style.display = 'none';
        
        // Real-time filter of displayed sports
        searchTimeout = setTimeout(() => {
            isSearching = searchQuery.length > 0;
            displayedSportsCount = isSearching ? 100 : INITIAL_LOAD; // Show all when searching
            renderAvailableSports(displayedSportsCount);
        }, 150); // Debounce delay
    });

    // Dropdown search for quick selection (shows top matches)
    let dropdownSearchTimeout;
    document.getElementById('sportSearch').addEventListener('input', function(e) {
        clearTimeout(dropdownSearchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        dropdownSearchTimeout = setTimeout(() => {
            const filteredSports = allSports.filter(sport => {
                const notSelected = !selectedSports.has(sport.id);
                const matchesQuery = sport.name.toLowerCase().includes(query.toLowerCase());
                return notSelected && matchesQuery;
            }).slice(0, 8); // Show top 8 matches
            
            if (filteredSports.length > 0) {
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = filteredSports.map(sport => `
                    <div class="sport-search-item" onclick="selectSportById(${sport.id}); document.getElementById('sportSearch').value = ''; searchQuery = ''; displayedSportsCount = INITIAL_LOAD; renderAvailableSports(displayedSportsCount); document.getElementById('searchResults').style.display = 'none';">
                        <div class="sport-search-item-content">
                            <span class="sport-search-icon">${sport.emoji}</span>
                            <span class="sport-search-name">${sport.name}</span>
                            <span class="sport-search-category">${sport.category}</span>
                        </div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            } else {
                document.getElementById('searchResults').style.display = 'none';
            }
        }, 200); // Debounce delay for dropdown
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#sportSearch') && !e.target.closest('#searchResults')) {
            document.getElementById('searchResults').style.display = 'none';
        }
    });

    // Category filter
    document.querySelectorAll('.category-filter').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentCategory = this.dataset.category;
            
            // Reset search when changing category
            searchQuery = '';
            document.getElementById('sportSearch').value = '';
            isSearching = false;
            displayedSportsCount = INITIAL_LOAD;
            
            renderAvailableSports(displayedSportsCount);
        });
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSports();
    });

    // Client-side validation
    document.getElementById('sportsForm').addEventListener('submit', function(e) {
        const errorDiv = document.getElementById('sports-error');
        
        if (selectedSports.size === 0) {
            e.preventDefault();
            errorDiv.style.display = 'block';
        } else {
            errorDiv.style.display = 'none';
        }
    });
</script>
{% endblock %}
